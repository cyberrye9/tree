<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>The Markel Conspiracy · An Anatomy of a Murder-for-Hire</title>
<style>
/* === UI HINTS (Centered & Styled) === */
.interaction-hint {
  display: none;
}

.hint-icon {
  font-size: 0.9rem;
  opacity: 0.6;
}

/* === SCROLL ARROW (Bouncing) === */
.scroll-indicator {
  display: none;
}

.scroll-text {
  font-family: var(--sans);
  font-size: 0.6rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--red);
  background: rgba(255, 255, 255, 0.8);
  padding: 4px 8px;
  border-radius: 4px;
}

.scroll-indicator svg {
  stroke: var(--red);
  opacity: 0.8;
}

/* === ANIMATIONS === */
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
  40% { transform: translateX(-50%) translateY(-8px); }
  60% { transform: translateX(-50%) translateY(-4px); }
}

@keyframes fadeIn {
  to { opacity: 1; }
}

/* === SPACING FIX (Removes the large gap) === */
.conspiracy-section {
  display: none;
}

/* Hide sections not needed in side-by-side layout */
.pullquote-section,
.sources-section {
  display: none;
}
@import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Inter:wght@400;500;600&family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,500;1,6..72,400&display=swap');

:root {
  --black: #111;
  --white: #faf9f7;
  --cream: #f4f1eb;
  --gray-100: #e8e5df;
  --gray-200: #d1cdc5;
  --gray-400: #8a8680;
  --gray-600: #5c5955;
  --red: #8b0000;
  --gold: #9a7b4f;
  --serif: 'Instrument Serif', Georgia, serif;
  --body: 'Newsreader', Georgia, serif;
  --sans: 'Inter', -apple-system, sans-serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html {
  font-size: 16px;
  -webkit-font-smoothing: antialiased;
}

body {
  background: var(--cream);
  color: var(--black);
  font-family: var(--body);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* Grain overlay */
.grain {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 10000;
  opacity: 0.03;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

/* ============ HEADER ============ */
header {
  display: none;
}

/* Left panel masthead */
.hero-masthead {
  font-family: var(--sans);
  font-size: 0.65rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--gray-600);
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--gray-200);
}


.masthead {
  font-family: var(--sans);
  font-size: 0.65rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--gray-600);
}

.header-nav {
  display: flex;
  gap: 32px;
}

.header-nav a {
  font-family: var(--sans);
  font-size: 0.7rem;
  font-weight: 500;
  text-decoration: none;
  color: var(--black);
  opacity: 0.5;
  transition: opacity 0.2s;
}
.header-nav a:hover { opacity: 1; }

/* ============ HERO (Header Section) ============ */
.hero {
  position: relative;
  width: 420px;
  flex-shrink: 0;
  height: 100vh;
  overflow-y: auto;
  padding: 40px 40px 40px 40px;
  background: var(--cream);
  border-right: 2px solid var(--gray-200);
}

.hero-kicker {
  font-family: var(--sans);
  font-size: 0.65rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.15em;
  color: var(--red);
  margin-bottom: 16px;
}

.hero-title {
  font-family: var(--serif);
  font-size: clamp(2rem, 4vw, 2.5rem);
  font-weight: 400;
  line-height: 1.1;
  letter-spacing: -0.02em;
  margin-bottom: 24px;
}

.hero-subtitle {
  font-family: var(--body);
  font-size: 1rem;
  font-weight: 400;
  line-height: 1.5;
  color: var(--gray-600);
}

.hero-meta {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid var(--gray-200);
  font-family: var(--sans);
  font-size: 0.7rem;
  color: var(--gray-400);
  display: flex;
  gap: 24px;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============ CANVAS SECTION ============ */
.canvas-section {
  position: relative;
  flex: 1;
  height: 100vh;
  overflow: hidden;
  background: var(--white);
}

.tree-viewport {
  position: absolute;
  inset: 0;
  overflow: hidden;
}

.tree-canvas {
  position: absolute;
  width: 1500px;
  height: 950px;
  left: 0;
  top: 0;
  transform-origin: 0 0;
  transition: transform 0.9s cubic-bezier(0.34, 1.56, 0.64, 1);
  /* Initial scale and position calculated by JavaScript */
}

.tree-canvas.locked {
  transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* SVG connections with draw animation */
.connections {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 1; 
}

.connections line {
  stroke: var(--gray-200);
  stroke-width: 1;
  stroke-dasharray: 1000;
  stroke-dashoffset: 1000;
  animation: drawLine 2s ease forwards;
}

.connections .marriage {
  stroke-dasharray: 4 4;
  stroke: var(--gray-400);
  animation: drawLineDashed 2s ease forwards;
}

.connections .conspiracy {
  stroke: var(--red);
  stroke-width: 1.5;
  opacity: 0.5;
  animation: drawLineConspiracy 2.5s ease 0.5s forwards;
  stroke-dashoffset: 1000;
}

.connections circle {
  fill: var(--white);
  stroke: var(--gray-200);
  stroke-width: 1;
  opacity: 0;
  animation: fadeIn 0.5s ease 1.5s forwards;
}

@keyframes drawLine {
  to { stroke-dashoffset: 0; }
}

@keyframes drawLineDashed {
  to { stroke-dashoffset: 0; }
}

@keyframes drawLineConspiracy {
  from { stroke-dashoffset: 1000; opacity: 0; }
  to { stroke-dashoffset: 0; opacity: 0.5; }
}

@keyframes fadeIn {
  to { opacity: 1; }
}

/* Line labels */
.line-label {
  position: absolute;
  font-family: var(--sans);
  font-size: 0.5rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--red);
  background: var(--white);
  padding: 2px 6px;
  opacity: 0;
  animation: fadeIn 0.5s ease 2s forwards;
  white-space: nowrap;
  z-index: 200; 
}

/* Section headers */
.tree-section {
  position: absolute;
  top: 0px;
  opacity: 0;
  animation: fadeUp 0.6s ease forwards;
  z-index: 5;
}

.tree-section:nth-child(1) { animation-delay: 0.2s; }
.tree-section:nth-child(2) { animation-delay: 0.3s; }
.tree-section:nth-child(3) { animation-delay: 0.4s; }

.tree-section::before {
  content: attr(data-num);
  display: block;
  font-family: var(--serif);
  font-style: italic;
  font-size: 2rem;
  font-weight: 500;
  color: var(--black);
  margin-bottom: 14px;
}

.tree-section-title {
  font-family: var(--sans);
  font-size: 1.2rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.2em;
  color: var(--black);
  margin-bottom: 12px;
}

.tree-section-desc {
  font-family: var(--body);
  font-size: 1.05rem;
  font-style: italic;
  color: var(--gray-600);
  max-width: 240px;
  line-height: 1.5;
}

/* ============ PERSON CARD ============ */
.person {
  position: absolute;
  width: 125px;
  cursor: pointer;
  opacity: 0;
  transform: translateY(15px);
  transition: opacity 0.5s ease, transform 0.5s ease;
  z-index: 10; 
}

.person.visible {
  opacity: 1;
  transform: translateY(0);
}

.tree-canvas.focused .person {
  opacity: 0.12;
}

.tree-canvas.focused .person.active {
  opacity: 1;
}

.tree-canvas.locked .person:not(.active) {
  opacity: 0.12;
}

.person-photo {
  position: relative;
   width: 96px;
  height: 120px;

  margin: 0 auto;
  background: var(--gray-100);
  overflow: hidden;
  transition: transform 0.4s ease, box-shadow 0.4s ease;
}

.person:hover .person-photo {
  transform: scale(1.03);
}

.person.active .person-photo {
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

/* Vignette + duotone effect */
.person-photo::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(154,123,79,0.15) 0%, transparent 50%, rgba(139,0,0,0.1) 100%);
  opacity: 0;
  transition: opacity 0.5s;
  z-index: 2;
}

.person:hover .person-photo::before,
.person.active .person-photo::before {
  opacity: 1;
}

.person-photo::after {
  content: '';
  position: absolute;
  inset: 0;
  box-shadow: inset 0 0 30px rgba(0,0,0,0.2);
  opacity: 0;
  transition: opacity 0.4s;
  z-index: 3;
}

.person:hover .person-photo::after,
.person.active .person-photo::after {
  opacity: 1;
}

.person-photo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: grayscale(100%) contrast(1.1);
  transition: filter 0.6s ease;
}

.person:hover .person-photo img,
.person.active .person-photo img {
  filter: grayscale(0%) contrast(1.05) saturate(1.1);
}

/* Status indicator - HIDDEN */
.person-indicator {
  display: none;
}

.person.victim .person-status { background: var(--gold); }
.person.convicted .person-status { background: var(--red); }
.person-status.outline {
  background: transparent;
  color: var(--black);
  border: 1px solid var(--gray-400);
}

.person-info {
  margin-top: 14px;
  text-align: center;
}

.person-name {
  font-family: var(--serif);
  font-size: 0.85rem;
  font-weight: 400;
  line-height: 1.25;
  color: var(--black);
}

.person-role {
  font-family: var(--sans);
  font-size: 0.55rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--gray-400);
  margin-top: 4px;
}

.person-status {
  display: inline-block;
  margin-top: 8px;
  padding: 3px 8px;
  font-family: var(--sans);
  font-size: 0.5rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  background: var(--black);
  color: var(--white);
}

/* ============ INFO PANEL ============ */
.info-panel {
  position: fixed;
  left: clamp(20px, 4vw, 60px);
  bottom: 40px;
  width: 400px;
  max-height: calc(100vh - 150px);
  overflow-y: auto;
  background: var(--white);
  border: 1px solid var(--gray-200);
  padding: 28px 32px;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  pointer-events: none;
  z-index: 500;
}

.info-panel.visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.info-panel::before {
  content: '';
  position: absolute;
  top: 28px;
  left: -1px;
  width: 3px;
  height: 40px;
  background: var(--black);
}

.info-panel.victim::before { background: var(--gold); }
.info-panel.convicted::before { background: var(--red); }

.info-eyebrow {
  font-family: var(--sans);
  font-size: 0.6rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--gray-400);
  margin-bottom: 8px;
}

.info-name {
  font-family: var(--serif);
  font-size: 1.75rem;
  font-weight: 400;
  line-height: 1.15;
  margin-bottom: 6px;
}

.info-role {
  font-family: var(--sans);
  font-size: 0.7rem;
  font-weight: 500;
  color: var(--gray-600);
  margin-bottom: 16px;
}

.info-status {
  display: inline-block;
  padding: 6px 12px;
  font-family: var(--sans);
  font-size: 0.6rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  background: var(--black);
  color: var(--white);
  margin-bottom: 20px;
}

.info-dates {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--gray-100);
}

.info-date-item {
  display: flex;
  flex-direction: column;
}

.info-date-label {
  font-family: var(--sans);
  font-size: 0.55rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--gray-400);
  margin-bottom: 4px;
}

.info-date-value {
  font-family: var(--body);
  font-size: 0.85rem;
  color: var(--black);
}

.info-bio {
  font-family: var(--body);
  font-size: 0.95rem;
  line-height: 1.65;
  color: var(--gray-600);
  margin-bottom: 20px;
}

.info-quote {
  padding: 16px;
  background: var(--cream);
  border-left: 2px solid var(--red);
  margin-bottom: 20px;
}

.info-quote-text {
  font-family: var(--body);
  font-size: 0.9rem;
  font-style: italic;
  line-height: 1.5;
  color: var(--gray-600);
  margin-bottom: 8px;
}

.info-quote-attr {
  font-family: var(--sans);
  font-size: 0.6rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--gray-400);
}

.info-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: var(--sans);
  font-size: 0.7rem;
  font-weight: 500;
  color: var(--red);
  text-decoration: none;
  transition: opacity 0.2s;
}

.info-link:hover { opacity: 0.7; }

.info-link svg {
  width: 12px;
  height: 12px;
}

/* ============ TOUR CONTROLS ============ */
.tour-controls {
  position: fixed;
  bottom: 30px;
  left: 30px; 
  right: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 600;
}

.tour-btn {
  padding: 10px 16px;
  font-family: var(--sans);
  font-size: 0.65rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  border: 1px solid var(--gray-200);
  background: var(--white);
  color: var(--black);
  cursor: pointer;
  transition: all 0.2s;
}

.tour-btn:hover {
  background: var(--black);
  color: var(--white);
  border-color: var(--black);
}

.tour-btn.active {
  background: var(--red);
  color: var(--white);
  border-color: var(--red);
}

.tour-progress {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: var(--white);
  border: 1px solid var(--gray-200);
}

.tour-progress.visible {
  display: flex;
}

.tour-step {
  font-family: var(--sans);
  font-size: 0.6rem;
  color: var(--gray-600);
}

.tour-nav {
  display: flex;
  gap: 4px;
}

.tour-nav button {
  width: 28px;
  height: 28px;
  border: 1px solid var(--gray-200);
  background: var(--white);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.tour-nav button:hover {
  background: var(--black);
  color: var(--white);
}

/* ============ ANNOTATIONS ============ */
.annotation {
  position: absolute;
  max-width: 160px;
  font-family: var(--body);
  font-size: 0.75rem;
  font-style: italic;
  line-height: 1.45;
  color: var(--gray-400);
  z-index: 5;
  background: var(--white);
  padding: 6px 10px;
  border-left: 2px solid var(--gray-200);
  opacity: 0;
  animation: fadeIn 0.5s ease 2.5s forwards;
  pointer-events: none;
}

.annotation.conspiracy {
  border-left-color: var(--red);
  color: var(--gray-600);
}

/* ============ LEGEND ============ */
.legend {
  margin-top: 24px;        /* was 40px */
  padding-top: 18px;       /* was 30px */
  border-top: 1px solid var(--gray-200);
}

.legend-title {
  font-family: var(--sans);
  font-size: 0.7rem;       /* was 0.75rem */
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.22em;
  color: var(--black);
  margin-bottom: 10px;     /* was 18px */
}

.legend-item {
  display: flex;
  align-items: center;
  margin-bottom: 6px;      /* was 8px */
}

.legend-line {
  width: 32px;             /* was 40px */
  height: 2px;
  margin-right: 8px;       /* was 10px */
  background: var(--gray-200);
}

.legend-dot {
  width: 10px;             /* was 12px */
  height: 10px;            /* was 12px */
  border-radius: 50%;
  margin-right: 8px;       /* was 10px */
}

.legend-label {
  font-family: var(--sans);
  font-size: 0.62rem;      /* was 0.65rem */
  color: var(--black);
  font-weight: 500;
}

/* ============ KEYBOARD HINT ============ */
.keyboard-hint {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 16px;
  font-family: var(--sans);
  font-size: 0.55rem;
  color: var(--gray-400);
  z-index: 100;
  opacity: 0;
  animation: fadeIn 0.5s ease 2s forwards;
  transition: opacity 0.3s;
}

.keyboard-hint.hidden {
  opacity: 0;
  pointer-events: none;
}

.keyboard-hint kbd {
  display: inline-block;
  padding: 2px 6px;
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: 3px;
  font-family: var(--sans);
  margin-right: 4px;
}

/* ============ CLOSE VIEW BUTTON ============ */
.close-view-btn {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  padding: 12px 24px;
  background: var(--black);
  color: var(--white);
  border: none;
  font-family: var(--sans);
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  cursor: pointer;
  z-index: 1000;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.close-view-btn.visible {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: auto;
}

.close-view-btn:hover {
  background: var(--red);
}

.close-view-btn span {
  opacity: 0.5;
  font-weight: 400;
  margin-left: 4px;
}

/* ============ PULLQUOTE SECTION ============ */
.pullquote-section {
  padding: 10px clamp(20px, 8vw, 120px) 80px; /* Minimal top padding */
  max-width: 900px;
}

.pullquote {
  font-family: var(--serif);
  font-size: clamp(1.5rem, 3vw, 2rem);
  font-style: italic;
  line-height: 1.4;
  color: var(--black);
  border-left: 2px solid var(--red);
  padding-left: 28px;
}

.pullquote-attr {
  margin-top: 20px;
  padding-left: 28px;
  font-family: var(--sans);
  font-size: 0.7rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--gray-400);
}

/* ============ SOURCES FOOTER ============ */
.sources-section {
  padding: 60px clamp(20px, 8vw, 120px);
  border-top: 1px solid var(--gray-200);
  background: var(--cream);
}

.sources-title {
  font-family: var(--sans);
  font-size: 0.65rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--gray-400);
  margin-bottom: 20px;
}

.sources-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 30px;
}

.source-item {
  font-family: var(--body);
  font-size: 0.85rem;
  line-height: 1.5;
  color: var(--gray-600);
}

.source-item strong {
  font-family: var(--sans);
  font-size: 0.7rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--black);
  display: block;
  margin-bottom: 6px;
}

.credits {
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid var(--gray-200);
  font-family: var(--sans);
  font-size: 0.7rem;
  color: var(--gray-400);
}

/* ============ PRINT STYLES ============ */
@media print {
  .grain, header, .tour-controls, .minimap, .keyboard-hint, .legend, .close-view-btn {
    display: none !important;
  }
  
  .hero, .canvas-section, .pullquote-section, .sources-section {
    page-break-inside: avoid;
  }
  
  .tree-canvas {
    transform: none !important;
    position: relative !important;
  }
  
  .person {
    opacity: 1 !important;
    transform: none !important;
  }
  
  .connections line {
    stroke-dashoffset: 0 !important;
    animation: none !important;
  }
  
  body {
    background: white;
  }
}

/* ============ RESPONSIVE ============ */
@media (max-width: 900px) {
  .info-panel {
    left: 20px;
    right: 20px;
    width: auto;
    max-height: 50vh;
  }
  
  .minimap, .keyboard-hint { display: none; }
}
</style>

</head>
<body>

<div class="grain"></div>

<header>
  <div class="masthead">The Murder of Dan Markel</div>
  <nav class="header-nav">
    <a href="index2.html">Profiles</a>
    <a href="tl2.html">Timeline</a>
  </nav>
</header>

<section class="hero">
  <div class="hero-masthead">The Murder of Dan Markel</div>
  <div class="hero-kicker">INTERACTIVE TIMELINE</div>
  <h1 class="hero-title">The Family Tree of a Murder Conspiracy</h1>
  <p class="hero-subtitle">How a bitter custody dispute led a prominent South Florida family to orchestrate the assassination of a law professor — and how investigators untangled the web of relationships that connected them to the killers.</p>
  <div class="legend">
    <div class="legend-title">Key</div>
    <div class="legend-item">
      <div class="legend-line"></div>
      <span class="legend-label">Family</span>
    </div>
    <div class="legend-item">
      <div class="legend-line dashed"></div>
      <span class="legend-label">Marriage</span>
    </div>
    <div class="legend-item">
      <div class="legend-line red"></div>
      <span class="legend-label">Conspiracy</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot gold"></div>
      <span class="legend-label">Victim</span>
    </div>
    <div class="legend-item">
      <div class="legend-dot red"></div>
      <span class="legend-label">Convicted</span>
    </div>
  </div>
<section class="canvas-section">
  <div class="tour-controls">
    <button class="tour-btn" id="startTour">▶ Guided Tour</button>
    <div class="tour-progress" id="tourProgress">
      <span class="tour-step" id="tourStep">1 / 5</span>
      <div class="tour-nav">
        <button id="tourPrev">←</button>
        <button id="tourNext">→</button>
      </div>
      <button id="tourEnd" style="margin-left: 8px; font-size: 0.6rem;">✕</button>
    </div>
  </div>
<div class="interaction-hint">
  <span class="hint-icon"></span>
  <span>Hover to Reveal Profile</span>
</div>


  <div class="tree-viewport">
    <div class="tree-canvas" id="tree">
      
      <svg class="connections" id="connections" viewBox="0 0 1500 950"></svg>
      
      <div class="line-label" style="left: 150px; top: 505px;">Mastermind</div>
      <div class="line-label" style="left: 630px; top: 510px;">Recruited</div>
      <div class="line-label" style="left: 845px; top: 300px;">Partners</div>
      
      <div class="tree-section" data-num="i." style="left: 100px;">
        <div class="tree-section-title">The Adelson Family</div>
        <div class="tree-section-desc">A prominent South Florida family at the center of the conspiracy</div>
      </div>
      
      <div class="tree-section" data-num="ii." style="left: 425px;">
        <div class="tree-section-title">The Markel Family</div>
        <div class="tree-section-desc">The victim's family, fighting for justice for over a decade</div>
      </div>
      
      <div class="tree-section" data-num="iii." style="left: 745px;">
        <div class="tree-section-title">The Conspirators</div>
        <div class="tree-section-desc">Hired through a chain of personal relationships</div>
      </div>
      
   
      <div class="person" data-id="harvey" data-index="0" style="left: 80px; top: 200px;">
        <div class="person-photo">
          <img src="harvey.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Harvey Adelson</div>
          <div class="person-role">Patriarch</div>
        </div>
      </div>
      
      <div class="person convicted" data-id="donna" data-index="1" style="left: 200px; top: 200px;">
        <div class="person-photo">
          <img src="donna.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Donna Adelson</div>
          <div class="person-role">Matriarch · Mastermind</div>
          <div class="person-status">Guilty · Life</div>
        </div>
      </div>
      
      <div class="person" data-id="rob" data-index="4" style="left: 20px; top: 620px;">
        <div class="person-photo">
          <img src="rob.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Rob Adelson</div>
          <div class="person-role">Brother · Financier</div>
        </div>
      </div>

      <div class="person convicted" data-id="charlie" data-index="2" style="left: 140px; top: 620px;">
        <div class="person-photo">
          <img src="charlie.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Charlie Adelson</div>
          <div class="person-role">Brother</div>
          <div class="person-status">Guilty · Life</div>
        </div>
      </div>
      
      <div class="person" data-id="wendi" data-index="3" style="left: 260px; top: 620px;">
        <div class="person-photo">
          <img src="wendi.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Wendi Adelson</div>
          <div class="person-role">Ex-Wife · Unindicted Con-Conspirator</div>
          <div class="person-status outline">Unindicted</div>
        </div>
      </div>
      
      <div class="person" data-id="phil" data-index="5" style="left: 385px; top: 200px;">
        <div class="person-photo">
          <img src="phil.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Phil Markel</div>
          <div class="person-role">Father</div>
        </div>
      </div>
      
      <div class="person" data-id="ruth" data-index="6" style="left: 505px; top: 200px;">
        <div class="person-photo">
          <img src="ruth.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Ruth Markel</div>
          <div class="person-role">Mother</div>
        </div>
      </div>
      
      <div class="person victim" data-id="dan" data-index="7" style="left: 385px; top: 620px;">
        <div class="person-photo">
          <img src="dan.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Dan Markel</div>
          <div class="person-role">Law Professor</div>
          <div class="person-status">Victim</div>
        </div>
      </div>
      
   
      
      
      <div class="person convicted" data-id="magbanua" data-index="11" style="left: 630px; top: 510px;">
        <div class="person-photo">
          <img src="magbanua.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Katherine Magbanua</div>
          <div class="person-role">Middleman</div>
          <div class="person-status">Guilty · Life</div>
        </div>
      </div>
      
      <div class="person convicted" data-id="garcia" data-index="12" style="left: 770px; top: 200px;">
        <div class="person-photo">
          <img src="garcia.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Sigfredo Garcia</div>
          <div class="person-role">Shooter</div>
          <div class="person-status">Life no parole</div>
        </div>
      </div>
      
      <div class="person" data-id="rivera" data-index="13" style="left: 920px; top: 510px;">
        <div class="person-photo">
          <img src="rivera.jpg" onerror="this.style.opacity='0'">
          <div class="person-indicator"></div>
        </div>
        <div class="person-info">
          <div class="person-name">Luis Rivera</div>
          <div class="person-role">Driver</div>
          <div class="person-status">19 years</div>
        </div>
      </div>
      
    </div>
  </div>
</section>

<section class="pullquote-section">
  <blockquote class="pullquote">
    "This was a family that believed they could buy their way out of anything — including murder."
  </blockquote>
  <div class="pullquote-attr">— Georgia Cappleman, Lead Prosecutor</div>
</section>

<div class="info-panel" id="infoPanel">
  <div class="info-eyebrow" id="infoEyebrow">Subject Profile</div>
  <div class="info-name" id="infoName"></div>
  <div class="info-role" id="infoRole"></div>
  <div class="info-status" id="infoStatus"></div>
  <div class="info-dates" id="infoDates"></div>
  <div class="info-bio" id="infoBio"></div>
  <div class="info-quote" id="infoQuote">
    <div class="info-quote-text" id="infoQuoteText"></div>
    <div class="info-quote-attr" id="infoQuoteAttr"></div>
  </div>
  <a class="info-link" id="infoLink" href="#">
    View full profile
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M5 12h14M12 5l7 7-7 7"/>
    </svg>
  </a>
</div>

<div class="keyboard-hint" id="keyboardHint">
  <span><kbd>←</kbd><kbd>→</kbd> Navigate</span>
  <span><kbd>Esc</kbd> Reset view</span>
  <span><kbd>L</kbd> Lock focus</span>
</div>

<button id="closeViewBtn" class="close-view-btn">CLOSE VIEW <span>(ESC)</span></button>

<section class="sources-section">
  <h3 class="sources-title">Sources & Methodology</h3>
  <div class="sources-grid">
    <div class="source-item">
      <strong>Court Records</strong>
      Florida Second Judicial Circuit Court, Case No. 2016-CF-2544 (Garcia), 2016-CF-2545 (Magbanua), 2022-CF-1584 (Charlie Adelson), 2023-CF-2891 (Donna Adelson)
    </div>
    <div class="source-item">
      <strong>Trial Testimony</strong>
      Transcripts from the trials of Sigfredo Garcia (2019), Katherine Magbanua (2019, 2022), Charlie Adelson (2023), and Donna Adelson (2024)
    </div>
    <div class="source-item">
      <strong>Law Enforcement</strong>
      Tallahassee Police Department investigative files, FBI surveillance recordings, Florida Department of Law Enforcement reports
    </div>
    <div class="source-item">
      <strong>Reporting</strong>
      Original reporting supplemented by coverage from the Tallahassee Democrat, Miami Herald, and ABC News 20/20
    </div>
  </div>
  <div class="credits">
Research, interactive design, and data visualization by Ryann Ashley Ersoff</div>
</section>

<script>
const DATA = {
  harvey: {
    name: 'Harvey Adelson',
    role: 'Patriarch · Periodontist',
    status: '',
    type: '',
    dates: [],
    bio: 'Donna\'s husband and father to Charlie, Wendi, and Rob. A successful South Florida periodontist who has not been charged in connection with the murder conspiracy.',
    quote: '',
    quoteAttr: '',
    link: '#'
  },
  donna: {
    name: 'Donna Adelson',
    role: 'Matriarch · Mastermind',
    status: 'Life + 60 Years',
    type: 'convicted',
    dates: [
      { label: 'Arrested', value: 'Aug 1, 2023' },
      { label: 'Convicted', value: 'Nov 22, 2024' }
    ],
    bio: 'Convicted in 2024 of first-degree murder and conspiracy. Prosecutors argued she was the driving force behind the plot to kill her ex-son-in-law, motivated by a desire to keep her grandchildren in Florida.',
    quote: 'She was the puppet master, pulling all the strings.',
    quoteAttr: 'Lead Prosecutor Georgia Cappleman',
    link: 'donna-adelson-trial.html'
  },
  charlie: {
    name: 'Charlie Adelson',
    role: 'Brother · Financier',
    status: 'Life + 30 Years',
    type: 'convicted',
    dates: [
      { label: 'Arrested', value: 'Apr 21, 2022' },
      { label: 'Convicted', value: 'Nov 6, 2023' }
    ],
    bio: 'A dentist who prosecutors say used his relationship with Katherine Magbanua to arrange his brother-in-law\'s murder for approximately $100,000. Convicted in 2023 after secretly recorded conversations implicated him.',
    quote: 'That thing I was telling you the other day about this whole situation, I think they have your phones tapped.',
    quoteAttr: 'From FBI undercover recording, 2016',
    link: 'charlie-adelson-trial.html'
  },
  wendi: {
    name: 'Wendi Adelson',
    role: 'Ex-Wife · Law Professor',
    status: 'Unindicted Co-Conspirator',
    type: '',
    dates: [
      { label: 'Divorced', value: 'Jul 2013' },
      { label: 'Status', value: 'Not charged' }
    ],
    bio: 'Dan Markel\'s ex-wife and mother of their two sons. Their contentious divorce and custody battle is believed to be the motive. Named as an unindicted co-conspirator but has never been charged.',
    quote: 'The motive in this case is very, very simple... Wendi Adelson wanted to move to South Florida.',
    quoteAttr: 'Prosecutor Georgia Cappleman',
    link: 'wendi.html'
  },
  rob: {
    name: 'Rob Adelson',
    role: 'Brother',
    status: '',
    type: '',
    dates: [],
    bio: 'Wendi and Charlie\'s brother. He has distanced himself from the family and was not implicated in the murder conspiracy.',
    quote: '',
    quoteAttr: '',
    link: '#'
  },
  phil: {
    name: 'Phil Markel',
    role: 'Father',
    status: '',
    type: '',
    dates: [],
    bio: 'Dan\'s father who has spent a decade fighting for a relationship with his grandsons Lincoln and Benjamin, who remain in the custody of the Adelson family.',
    quote: 'We will never stop fighting for justice for Danny and for our grandchildren.',
    quoteAttr: 'Phil Markel, victim impact statement',
    link: '#'
  },
  ruth: {
    name: 'Ruth Markel',
    role: 'Mother · Advocate',
    status: '',
    type: '',
    dates: [],
    bio: 'Dan\'s mother and tireless advocate for justice. Present at every trial, she has become a powerful symbol of the family\'s decade-long pursuit of accountability.',
    quote: '',
    quoteAttr: '',
    link: '#'
  },
  dan: {
    name: 'Dan Markel',
    role: 'FSU Law Professor',
    status: 'Murdered July 18, 2014',
    type: 'victim',
    dates: [
      { label: 'Born', value: 'May 8, 1972' },
      { label: 'Killed', value: 'Jul 18, 2014' }
    ],
    bio: 'A respected criminal law professor at Florida State University, prolific legal blogger, and devoted father. Shot in the head in his Tallahassee garage in what investigators determined was a murder-for-hire.',
    quote: 'Danny was the best of us. A brilliant mind, a loving father, and a principled man who stood by his convictions.',
    quoteAttr: 'Ruth Markel, victim impact statement',
    link: '#'
  },
  shelly: {
    name: 'Shelly Markel',
    role: 'Sister',
    status: '',
    type: '',
    dates: [],
    bio: 'Dan\'s sister who has supported her parents\' fight for justice and their efforts to maintain a relationship with Dan\'s sons.',
    quote: '',
    quoteAttr: '',
    link: '#'
  },
 
  magbanua: {
    name: 'Katherine Magbanua',
    role: 'Middleman · Conduit',
    status: 'Life + 60 Years',
    type: 'convicted',
    dates: [
      { label: 'Arrested', value: 'Oct 1, 2016' },
      { label: 'Convicted', value: 'May 27, 2022' }
    ],
    bio: 'The crucial link between the Adelson family and the hitmen. Charlie\'s girlfriend and mother of two children with Sigfredo Garcia. Convicted in 2022 after her first trial ended in a hung jury.',
    quote: 'She was the bridge between two worlds that should never have connected.',
    quoteAttr: 'Prosecutor Georgia Cappleman',
    link: 'katherine-magbanua-trial.html'
  },
  garcia: {
    name: 'Sigfredo Garcia',
    role: 'Triggerman',
    status: 'Life Without Parole',
    type: 'convicted',
    dates: [
      { label: 'Arrested', value: 'Jun 2, 2016' },
      { label: 'Convicted', value: 'Oct 11, 2019' }
    ],
    bio: 'The man who pulled the trigger. A Latin Kings gang member who was recruited through his relationship with Katherine Magbanua, the mother of his children. Convicted in 2019.',
    quote: 'Garcia drove 400 miles to Tallahassee, shot a man he had never met, and drove 400 miles home. All for money.',
    quoteAttr: 'Prosecutor Georgia Cappleman',
    link: 'sigfredo-garcia-trial.html'
  },
  rivera: {
    name: 'Luis Rivera',
    role: 'Driver · State Witness',
    status: '19 Years',
    type: '',
    dates: [
      { label: 'Arrested', value: 'Jun 2, 2016' },
      { label: 'Plea Deal', value: '2017' }
    ],
    bio: 'Garcia\'s accomplice who drove the getaway car. His decision to take a plea deal and testify as the state\'s star witness was crucial to securing convictions against all other defendants.',
    quote: 'I\'m doing this to tell the truth... and because I want to see my kids again someday.',
    quoteAttr: 'Luis Rivera, trial testimony',
    link: 'rivera.html'
  }
};

// Elements
const tree = document.getElementById('tree');
const infoPanel = document.getElementById('infoPanel');
const closeBtn = document.getElementById('closeViewBtn');
const keyboardHint = document.getElementById('keyboardHint');

// State
let hoverTimer = null;
let isLocked = false;
let currentPerson = null;
let currentIndex = -1;
const people = Array.from(document.querySelectorAll('.person'));
const peopleIds = ['harvey','donna','charlie','wendi','rob','phil','ruth','dan','shelly','lincoln','benjamin','magbanua','garcia','rivera'];

// Tour state
let tourActive = false;
let tourStep = 0;
const tourStops = ['donna', 'charlie', 'magbanua', 'garcia', 'dan'];

// Staggered entrance animation
function animateEntrance() {
  people.forEach((person, i) => {
    setTimeout(() => {
      person.classList.add('visible');
    }, 300 + i * 80);
  });
}
// Draw connection lines
function drawConnections() {
  const svg = document.getElementById('connections');
  
  function getPos(id) {
    const el = document.querySelector(`[data-id="${id}"]`);
    if (!el) return null;
    const photo = el.querySelector('.person-photo');
    const w = photo.offsetWidth;
    const h = photo.offsetHeight;
    return {
      cx: el.offsetLeft + el.offsetWidth / 2,
      cy: el.offsetTop + h / 2,
      bottom: el.offsetTop + h,
      top: el.offsetTop
    };
  }
  
  let lines = '';
  
  function line(x1, y1, x2, y2, cls = '') {
    return `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" class="${cls}"/>`;
  }
  
  // This function must exist to prevent errors, but returning '' makes the dots invisible
  function node(x, y) {
    return ''; 
  }
  
  // Marriages
  const harvey = getPos('harvey'), donna = getPos('donna');
  if (harvey && donna) lines += line(harvey.cx, harvey.cy, donna.cx, donna.cy, 'marriage');
  
  const phil = getPos('phil'), ruth = getPos('ruth');
  if (phil && ruth) lines += line(phil.cx, phil.cy, ruth.cx, ruth.cy, 'marriage');
  
  const wendi = getPos('wendi'), dan = getPos('dan');
  if (wendi && dan) {
    lines += line(wendi.cx, wendi.cy, dan.cx, dan.cy, 'marriage');
    lines += node((wendi.cx + dan.cx) / 2, (wendi.cy + dan.cy) / 2);
  }
  
  // Adelson family tree
  const charlie = getPos('charlie'), rob = getPos('rob');
  if (harvey && donna && charlie && wendi && rob) {
    const parentMid = (harvey.cx + donna.cx) / 2;
    const junctionY = 410;
    lines += line(parentMid, harvey.bottom + 10, parentMid, junctionY);
    lines += node(parentMid, junctionY);
    
    // Connect to children: Rob, Charlie, Wendi
    lines += line(charlie.cx, junctionY, charlie.cx, charlie.top);
    lines += line(wendi.cx, junctionY, wendi.cx, wendi.top);
    lines += line(rob.cx, junctionY, rob.cx, rob.top);
    // Horizontal connector
    const minX = Math.min(rob.cx, charlie.cx, wendi.cx);
    const maxX = Math.max(rob.cx, charlie.cx, wendi.cx);
    lines += line(minX, junctionY, maxX, junctionY);
  }
  
  // Markel family tree
  const shelly = getPos('shelly');
  if (phil && ruth && dan && shelly) {
    const parentMid = (phil.cx + ruth.cx) / 2;
    const junctionY = 410;
    lines += line(parentMid, phil.bottom + 10, parentMid, junctionY);
    lines += node(parentMid, junctionY);
    lines += line(dan.cx, junctionY, shelly.cx, junctionY);
    lines += line(dan.cx, junctionY, dan.cx, dan.top);
    lines += line(shelly.cx, junctionY, shelly.cx, shelly.top);
  }
  
  
  // Conspiracy lines
  const magbanua = getPos('magbanua'), garcia = getPos('garcia'), rivera = getPos('rivera');
  
  if (donna && charlie) {
    // Donna to Charlie (Mastermind) - connect fully with no gap
    lines += line(donna.cx, donna.bottom + 10, charlie.cx + 20, charlie.top, 'conspiracy');
  }
  
  if (charlie && magbanua) {
    // Charlie to Magbanua (Money Flow) - connect edge to edge with no gap
    lines += line(charlie.cx + 62.5, charlie.cy, magbanua.cx - 62.5, magbanua.cy, 'conspiracy');
  }
  
  if (magbanua && garcia) {
    // Magbanua to Garcia - bent line extending to bottom of Garcia
    lines += line(magbanua.cx, magbanua.top, magbanua.cx, garcia.bottom, 'conspiracy');
    lines += line(magbanua.cx, garcia.bottom, garcia.cx, garcia.bottom, 'conspiracy');
  }
  
  if (garcia && rivera) {
    // Partners - bent line extending to edges
    const garciaRight = garcia.cx + 62.5; // Right edge of Garcia
    const riveraLeft = rivera.cx - 62.5;  // Left edge of Rivera
    const midX = (garciaRight + riveraLeft) / 2;
    lines += line(garciaRight, garcia.cy, midX, garcia.cy, 'conspiracy');
    lines += line(midX, garcia.cy, midX, rivera.cy, 'conspiracy');
    lines += line(midX, rivera.cy, riveraLeft, rivera.cy, 'conspiracy');
  }
  
  svg.innerHTML = lines;
}

// Zoom to person (Fixed: Auto-scrolls and clears header)
function zoomTo(person, lock = false) {
  const photo = person.querySelector('.person-photo');
  if (!photo) return;

  // 1. FORCE SCROLL: Auto-scroll to the map so it's visible
  document.querySelector('.canvas-section').scrollIntoView({ behavior: 'smooth', block: 'center' });

  const photoCenterX = person.offsetLeft + (photo.offsetWidth / 2);
  const photoCenterY = person.offsetTop + (photo.offsetHeight / 2);

  const viewport = document.querySelector('.tree-viewport');
  const vw = viewport.offsetWidth;
  const vh = viewport.offsetHeight;

  const scale = 1.8;
  const offsetX = (vw / 2) - (photoCenterX * scale);
  
  // 2. SHIFT DOWN: Added +80px so the face isn't hidden by the top header
  const offsetY = ((vh / 2) - (photoCenterY * scale)) + 80;

  tree.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  tree.classList.add('focused');
  if (lock) tree.classList.add('locked');

  people.forEach(p => p.classList.remove('active'));
  person.classList.add('active');
  currentPerson = person;
  currentIndex = parseInt(person.dataset.index);
  
  // SHOW CLOSE BUTTON, HIDE KEYBOARD HINT
  closeBtn.classList.add('visible');
  keyboardHint.classList.add('hidden');
}

// Reset zoom - Editorial "Fill Screen" Fix (with margins)
function resetZoom() {
  const viewport = document.querySelector('.tree-viewport');
  const vw = viewport.offsetWidth;
  const vh = viewport.offsetHeight;

  // Bounds for much taller, more vertical tree layout
  const contentMinX = 0;
  const contentMaxX = 1100;
  const contentMinY = 0; 
  const contentMaxY = 1150; // Bottom children at 1000 + 150 for labels
  
  const contentWidth = contentMaxX - contentMinX;
  const contentHeight = contentMaxY - contentMinY;
  
  const scaleX = vw / contentWidth;
  const scaleY = vh / contentHeight;
  
  // 1.02x for safe, conservative scaling that keeps all content visible
  const scale = Math.min(scaleX, scaleY) * 1.02;
  
  const treeCenterPointX = (contentMinX + contentMaxX) / 2;
  const treeCenterPointY = (contentMinY + contentMaxY) / 2;
  
  const offsetX = (vw / 2) - (treeCenterPointX * scale);
  const offsetY = (vh / 2) - (treeCenterPointY * scale);
  
  tree.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  
  tree.classList.remove('focused', 'locked');
  people.forEach(p => p.classList.remove('active'));
  isLocked = false;
  currentPerson = null;
  currentIndex = -1;
  closeBtn.classList.remove('visible');
  keyboardHint.classList.remove('hidden');
}

// Show info panel
function showInfo(id) {
  const d = DATA[id];
  if (!d) return;
  
  document.getElementById('infoName').textContent = d.name;
  document.getElementById('infoRole').textContent = d.role;
  
  const statusEl = document.getElementById('infoStatus');
  if (d.status) {
    statusEl.textContent = d.status;
    statusEl.style.display = 'inline-block';
    statusEl.style.background = d.type === 'victim' ? 'var(--gold)' : d.type === 'convicted' ? 'var(--red)' : 'var(--black)';
  } else {
    statusEl.style.display = 'none';
  }
  
  // Dates
  const datesEl = document.getElementById('infoDates');
  if (d.dates && d.dates.length) {
    datesEl.innerHTML = d.dates.map(dt => `
      <div class="info-date-item">
        <span class="info-date-label">${dt.label}</span>
        <span class="info-date-value">${dt.value}</span>
      </div>
    `).join('');
    datesEl.style.display = 'flex';
  } else {
    datesEl.style.display = 'none';
  }
  
  document.getElementById('infoBio').textContent = d.bio;
  
  // Quote
  const quoteEl = document.getElementById('infoQuote');
  if (d.quote) {
    document.getElementById('infoQuoteText').textContent = `"${d.quote}"`;
    document.getElementById('infoQuoteAttr').textContent = `— ${d.quoteAttr}`;
    quoteEl.style.display = 'block';
  } else {
    quoteEl.style.display = 'none';
  }
  
  // Link
  const linkEl = document.getElementById('infoLink');
  if (d.link && d.link !== '#') {
    linkEl.href = d.link;
    linkEl.style.display = 'inline-flex';
  } else {
    linkEl.style.display = 'none';
  }
  
  infoPanel.className = 'info-panel visible';
  if (d.type) infoPanel.classList.add(d.type);
}

function hideInfo() {
  infoPanel.classList.remove('visible', 'victim', 'convicted');
}

// Navigate to person by index
function navigateTo(index) {
  if (index < 0) index = people.length - 1;
  if (index >= people.length) index = 0;
  const person = people[index];
  zoomTo(person, isLocked);
  showInfo(person.dataset.id);
}

// Tour functions
function startTour() {
  tourActive = true;
  tourStep = 0;
  document.getElementById('startTour').classList.add('active');
  document.getElementById('tourProgress').classList.add('visible');
  goToTourStep(0);
}

function endTour() {
  tourActive = false;
  document.getElementById('startTour').classList.remove('active');
  document.getElementById('tourProgress').classList.remove('visible');
  resetZoom();
  hideInfo();
}

function goToTourStep(step) {
  tourStep = step;
  document.getElementById('tourStep').textContent = `${step + 1} / ${tourStops.length}`;
  const person = document.querySelector(`[data-id="${tourStops[step]}"]`);
  if (person) {
    zoomTo(person, true);
    showInfo(tourStops[step]);
  }
}
// Event handlers
people.forEach(person => {
  const photo = person.querySelector('.person-photo');
  const info = person.querySelector('.person-info');
  
  function handleEnter() {
    if (isLocked || tourActive) return;
    // Stop the zoom-out timer immediately if we come back to the person
    clearTimeout(hoverTimer);
    zoomTo(person);
    showInfo(person.dataset.id);
  }
  
  function handleLeave() {
    if (isLocked || tourActive) return;
    // Changed from 200 to 1500 (1.5 seconds)
    // This gives you time to read without it snapping away immediately
    hoverTimer = setTimeout(() => {
      resetZoom();
      hideInfo();
    }, 1500);
  }
  
  function handleClick(e) {
    e.stopPropagation();
    if (tourActive) return;
    if (isLocked && currentPerson === person) {
      isLocked = false;
      tree.classList.remove('locked');
    } else {
      isLocked = true;
      zoomTo(person, true);
      showInfo(person.dataset.id);
    }
  }
  
  photo.addEventListener('mouseenter', handleEnter);
  photo.addEventListener('mouseleave', handleLeave);
  info.addEventListener('mouseenter', handleEnter);
  info.addEventListener('mouseleave', handleLeave);
  person.addEventListener('click', handleClick);
});

// Panel hover
infoPanel.addEventListener('mouseenter', () => clearTimeout(hoverTimer));
infoPanel.addEventListener('mouseleave', () => {
  if (isLocked || tourActive) return;
  // Match the delay here too (1.5 seconds)
  hoverTimer = setTimeout(() => {
    resetZoom();
    hideInfo();
  }, 1500);
});

// CLOSE VIEW BUTTON HANDLER
closeBtn.addEventListener('click', () => {
  isLocked = false;
  resetZoom();
  hideInfo();
});

// Keyboard navigation
document.addEventListener('keydown', (e) => {
  if (tourActive) {
    if (e.key === 'ArrowRight') goToTourStep(Math.min(tourStep + 1, tourStops.length - 1));
    if (e.key === 'ArrowLeft') goToTourStep(Math.max(tourStep - 1, 0));
    if (e.key === 'Escape') endTour();
    return;
  }
  
  if (e.key === 'ArrowRight') navigateTo(currentIndex + 1);
  if (e.key === 'ArrowLeft') navigateTo(currentIndex - 1);
  if (e.key === 'Escape') {
    isLocked = false;
    resetZoom();
    hideInfo();
  }
  if (e.key === 'l' || e.key === 'L') {
    if (currentPerson) {
      isLocked = !isLocked;
      tree.classList.toggle('locked', isLocked);
    }
  }
});

// Tour controls
document.getElementById('startTour').addEventListener('click', () => {
  if (tourActive) endTour();
  else startTour();
});
document.getElementById('tourPrev').addEventListener('click', () => goToTourStep(Math.max(tourStep - 1, 0)));
document.getElementById('tourNext').addEventListener('click', () => goToTourStep(Math.min(tourStep + 1, tourStops.length - 1)));
document.getElementById('tourEnd').addEventListener('click', endTour);

// Click outside to reset
document.querySelector('.tree-viewport').addEventListener('click', (e) => {
  if (e.target.closest('.person')) return;
  if (tourActive) return;
  isLocked = false;
  resetZoom();
  hideInfo();
});

// Initialize
function init() {
  // Prevent browser from remembering scroll position on refresh
  if (history.scrollRestoration) {
    history.scrollRestoration = 'manual';
  }
  window.scrollTo(0, 0);

  drawConnections();
  resetZoom();
  animateEntrance();
}

window.addEventListener('load', init);
window.addEventListener('resize', () => {
  drawConnections();
  // Responsive resize handler
  if (isLocked && currentPerson) {
    zoomTo(currentPerson, true);
  } else if (!tourActive) {
    resetZoom();
  }
});
</script>
<script>
  // Expand/collapse evidence packets
  document.querySelectorAll('#conspiracyChain .chain-connector.evidence .evidence-head')
    .forEach(btn => {
      btn.addEventListener('click', () => {
        const connector = btn.closest('.chain-connector.evidence');
        const body = connector.querySelector('.evidence-body');
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        connector.querySelector('.evidence-toggle').textContent = expanded ? 'Expand' : 'Collapse';
        body.hidden = expanded;
      });
    });

  // Evidence filters
  const filterBtns = document.querySelectorAll('#conspiracyChain .filter-btn');
  const connectors = document.querySelectorAll('#conspiracyChain .chain-connector.evidence');
  const nodes = document.querySelectorAll('#conspiracyChain .chain-node');

  function setActive(btn){
    filterBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  function applyFilter(type){
    if(type === 'all'){
      connectors.forEach(c => c.classList.remove('is-dim'));
      nodes.forEach(n => n.classList.remove('is-dim'));
      return;
    }

    connectors.forEach(c => {
      const tags = (c.dataset.tags || '').split(',').map(s => s.trim());
      const match = tags.includes(type);
      c.classList.toggle('is-dim', !match);
    });

    // Nodes dim slightly less aggressively than connectors (keeps the chain readable)
    nodes.forEach(n => n.classList.add('is-dim'));
    setTimeout(() => nodes.forEach(n => n.classList.remove('is-dim')), 120);
  }

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      setActive(btn);
      applyFilter(btn.dataset.filter);
    });
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const chain = document.getElementById('conspiracyChain');
  if(!chain) return;

  const panel = document.getElementById('proofPanel');
  const panelKicker = document.getElementById('panelKicker');
  const panelTitle  = document.getElementById('panelTitle');
  const panelRole   = document.getElementById('panelRole');

  const panes = {
    overview: document.getElementById('paneOverview'),
    comms: document.getElementById('paneComms'),
    money: document.getElementById('paneMoney'),
    location: document.getElementById('paneLocation'),
    uc: document.getElementById('paneUC')
  };

  const tabs = Array.from(chain.querySelectorAll('.tab'));
  const filterBtns = Array.from(chain.querySelectorAll('.filter-btn'));
  const clickable = Array.from(chain.querySelectorAll('.chain-node, .chain-link'));
  const closePanel = document.getElementById('closePanel');

  function setTab(name){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    Object.keys(panes).forEach(k => panes[k].classList.toggle('active', k === name));
  }

  function fillPanel(el){
    const kind = el.dataset.kind || 'node';

    panelKicker.textContent = kind === 'link' ? 'Proof Packet' : 'Person';
    panelTitle.textContent = el.dataset.title || 'Proof Panel';
    panelRole.textContent  = el.dataset.role || '';

    panes.overview.textContent  = el.dataset.overview || 'Add overview text for this item.';
    panes.comms.textContent     = el.dataset.comms || 'Add communications proof here.';
    panes.money.textContent     = el.dataset.money || 'Add money-trail proof here.';
    panes.location.textContent  = el.dataset.location || 'Add phone/location proof here.';
    panes.uc.textContent        = el.dataset.uc || 'Add undercover/wiretap/cooperation proof here.';

    setTab('overview');
  }

  function clearFocus(){
    clickable.forEach(el => el.classList.remove('is-focus'));
  }

  function focusPath(fromId, toId){
    clearFocus();
    // focus nodes
    clickable.forEach(el => {
      if(el.dataset.id === fromId || el.dataset.id === toId) el.classList.add('is-focus');
      // focus connector
      if(el.dataset.kind === 'link' && el.dataset.from === fromId && el.dataset.to === toId) el.classList.add('is-focus');
    });
  }

  function openPanelFor(el){
    fillPanel(el);
    clearFocus();
    el.classList.add('is-focus');

    // if link, also highlight connected nodes
    if(el.dataset.kind === 'link'){
      focusPath(el.dataset.from, el.dataset.to);
    }
  }

  // Click handling (event delegation)
  chain.addEventListener('click', (e) => {
    const target = e.target.closest('.chain-node, .chain-link, .filter-btn, .tab, #closePanel, #walkChainBtn, #prevStep, #nextStep, #exitWalk');
    if(!target) return;

    // Tabs
    if(target.classList.contains('tab')){
      setTab(target.dataset.tab);
      return;
    }

    // Filters
    if(target.classList.contains('filter-btn')){
      filterBtns.forEach(b => b.classList.remove('active'));
      target.classList.add('active');

      const type = target.dataset.filter;
      if(type === 'all'){
        clickable.forEach(el => el.classList.remove('is-dim'));
      } else {
        clickable.forEach(el => {
          if(el.dataset.kind === 'link'){
            const tags = (el.dataset.tags || '').split(',').map(s => s.trim());
            el.classList.toggle('is-dim', !tags.includes(type));
          } else {
            // keep nodes slightly visible so the chain stays readable
            el.classList.remove('is-dim');
          }
        });
      }
      return;
    }

    // Panel close
    if(target.id === 'closePanel'){
      clearFocus();
      panelKicker.textContent = 'Click a person or packet';
      panelTitle.textContent = 'Proof Panel';
      panelRole.textContent = '';
      Object.keys(panes).forEach(k => panes[k].textContent = '');
      return;
    }

    // Walk mode controls handled below
    if(target.id === 'walkChainBtn' || target.id === 'prevStep' || target.id === 'nextStep' || target.id === 'exitWalk'){
      walkHandler(target.id);
      return;
    }

    // Node / Link click
    if(target.classList.contains('chain-node') || target.classList.contains('chain-link')){
      openPanelFor(target);
      return;
    }
  });

  // Walk the chain (guided)
  const walkBtn = document.getElementById('walkChainBtn');
  const guideNav = chain.querySelector('.guide-nav');
  const stepCount = document.getElementById('stepCount');
  const steps = [
    { elId: 'donna', kind: 'node' },
    { elId: 'donna-charlie', kind: 'link' },
    { elId: 'charlie-katie', kind: 'link' },
    { elId: 'katie-hitmen', kind: 'link' }
  ];
  let walkOn = false;
  let step = 0;

  function getByStep(s){
    const id = steps[s].elId;
    return clickable.find(el => el.dataset.id === id);
  }

  function renderStep(){
    const el = getByStep(step);
    if(el) openPanelFor(el);
    stepCount.textContent = `${step+1} / ${steps.length}`;
    el?.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  function walkHandler(actionId){
    if(actionId === 'walkChainBtn'){
      walkOn = true;
      walkBtn.hidden = true;
      guideNav.hidden = false;
      step = 0;
      renderStep();
      return;
    }
    if(actionId === 'exitWalk'){
      walkOn = false;
      walkBtn.hidden = false;
      guideNav.hidden = true;
      return;
    }
    if(!walkOn) return;
    if(actionId === 'prevStep') step = Math.max(0, step - 1);
    if(actionId === 'nextStep') step = Math.min(steps.length - 1, step + 1);
    renderStep();
  }

  // initialize panel content with something useful
  panes.overview.textContent = "Click a person or evidence packet on the left to populate this panel with a plain-language explanation + proof categories.";
  setTab('overview');
});
</script>

</body>
</html>
